<!doctype html><html lang=en-us>
<head>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=description content="Simple minimalist theme">
<meta name=keywords content="minimalist,blog,goa,hugo,developer">
<title>
technical debt - Push local docker images to your (air-gapped) k3s cluster
</title>
<meta name=generator content="Hugo 0.92.2">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Roboto+Slab:wght@400;700&family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700">
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.8.2/css/all.css integrity=sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay crossorigin=anonymous>
<link rel=stylesheet href=https://brice187.github.io/css/main.css>
<link rel=stylesheet href=https://brice187.github.io/css/custom.css>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png href=/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicon-16x16.png sizes=16x16>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<meta name=theme-color content="#ffffff">
</head>
<body lang=en-us>
<div class=container>
<header class="text-left title">
<h1 class=title>Push local docker images to your (air-gapped) k3s cluster</h1>
</header>
<section id=category-pane class=meta>
</section>
<section id=content-pane>
<div class="col-md-12 text-justify content">
<nav id=TableOfContents>
<ul>
<li><a href=#introduction>Introduction</a></li>
<li><a href=#using-local-images>Using local images</a>
<ul>
<li><a href=#deploy-local-images-to-hosts-in-your-network>Deploy local images to hosts in your network&lt;</a></li>
</ul>
</li>
<li><a href=#bonus-automating-image-deployment-with-gitlab-cicd>Bonus: Automating image deployment with Gitlab CI/CD</a></li>
<li><a href=#conclusion>Conclusion</a>
<ul>
<li><a href=#update>Update</a></li>
</ul>
</li>
</ul>
</nav>
<p>I am tipping my toe in the landscape of Kubernetes and found the lightweight, production-ready (and opionated)
k3s distribution is the perfect fit for my on-premises setup. Consider this as an experimental guide and use
it at your own risk (as you might know when using arbitrary code from the internet :)).</p>
<p>I found online only tutorials for running locally developed images without a container registry for minikube,
which can not be adapted to k3s or any other kubernetes distribution. I think this itches many developers
and there are no online ressources out there, so I decided to write my first technical blog post.</p>
<h2 id=introduction>Introduction</h2>
<p>I ran into the problem that my locally developed docker images which were manually transfered to the desired host,
were ignored by the node running the kubelet. I found out that even with <code>imagePullPolicy:Never</code> in the deployment
manifest, the docker images where ignored because k3s uses containerd as container runtime.</p>
<p>At first, I thought that k3s only works with images downloaded from a public or private container registry
by the k3s node. But I found a practical solution in the next chapter. Let me first give you some context
about the IT environment:</p>
<p>Our network is separated into multiple segments. The k3s cluster serving our web applications is located in
the demilitarized zone with no access to our container registry (the single source of truth regarding our container images)
in the development segment. Digging a hole in the packetfilter to access the internal network from the DMZ was
never an option. To avoid running an other infrastructure component like a registry in the DMZ or pay for
a private cloud registry (with possible security implications of public facing services serving the source of the business logic), I had to find an other approach to deploy containerd images on our webservers.</p>
<h2 id=using-local-images>Using local images</h2>
<p>Make sure your deployment manifest has the following pull policy:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my_app-deployment</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>my_app</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>my_app</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>my_app</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my_app</span>
        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>my_app:latest</span>
        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Never</span>
</code></pre></div><p>k3s ships with its own containerd runtime, which opens a socket at <code>/run/k3s/containerd/containerd.sock</code>.
If you are running k3s on your local workstation, you can simply import your local docker image (called
my_app for example) into containerd runtime with the following command <code>docker save my_app:latest | ctr -a /run/k3s/containerd/containerd.sock -n=k8s.io images import</code></p>
<p>It is important to use the namespace <strong>k8s.io</strong>, because the kubelet will only use images from this namespace.</p>
<p>So running a local developed application on the development workstation seems not a big deal, but consider the
next chapter to provision your whole cluster.</p>
<figure><img src=/img/container.jpg width=750>
</figure>
<h3 id=deploy-local-images-to-hosts-in-your-network>Deploy local images to hosts in your network&lt;</h3>
<p>Make sure that you have ssh access to the k3s hosts from the workstation or dev-server where you build the image.</p>
<p>Now create a system user/group called <code>k3s</code> for the image deployment on every kubelet node (or ask your sysadmin nicely).
Make sure you put your public ssh key into the <code>/home/k3s/.ssh/authorized_keys</code> and do a
<code>chown root:k3s /run/k3s/containerd/containerd.sock</code> on every node, so you can control the containerd runtimer
with the system user.</p>
<p>The last step is to extend the command of the previous chapter: <code>docker save my_app:latest | ssh k3s@node1 'ctr -a /run/k3s/containerd/containerd.sock -n=k8s.io images import -'</code>
Now the kubelet node will use this manually deployed image instead of trying to pull the image from hub.docker.com or running into famous <code>ImagePullBackOff</code>.</p>
<h2 id=bonus-automating-image-deployment-with-gitlab-cicd>Bonus: Automating image deployment with Gitlab CI/CD</h2>
<p>So this is pretty cool already, right? But how about automatic deployment with a CI/CD pipeline.
Make sure your gitlab_runner has the correct permission to access the k3s system user on the kubelet
nodes over ssh. Now you can add this deployment stage to your <code>.gitlab-ci.yml</code> in your software repository:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>deploy_app</span>:
  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
  <span style=color:#f92672>tags</span>:
    - <span style=color:#ae81ff>shell</span> <span style=color:#75715e># Tag for using a definded gitlab runner config</span>
  <span style=color:#f92672>script</span>:
    - <span style=color:#ae81ff>export IMAGE_TIMESTAMP=`date +%Y-%m-%d_%H-%M`</span>
    <span style=color:#75715e># Get standard images from Docker Hub</span>
    - <span style=color:#ae81ff>docker image pull mongo:4.2.3-bionic</span>
    <span style=color:#75715e># Build frontend app</span>
    - <span style=color:#ae81ff>docker build -t my_app src</span>
    <span style=color:#75715e>#### Optional: Push app to development registry myregistry.local</span>
    - <span style=color:#ae81ff>docker tag my_app myregistry.local/lk012/my_app:$IMAGE_TIMESTAMP</span>
    - <span style=color:#ae81ff>docker push myregistry.local/lk012/my_app:$IMAGE_TIMESTAMP</span>
      <span style=color:#ae81ff>for host in node1 node2 node3; do</span>
        <span style=color:#ae81ff>echo \&#34;#### Provisioning $host...</span> <span style=color:#75715e>####\&#34;</span>
        <span style=color:#ae81ff>docker save mongo:4.2.3-bionic | ssh k3s@$host &#39;ctr -a /run/k3s/containerd/containerd.sock -n=k8s.io images import -&#39;</span>
        <span style=color:#ae81ff>docker save my_app:latest | ssh k3s@$host &#39;ctr -a /run/k3s/containerd/containerd.sock -n=k8s.io images import -&#39;</span>
        <span style=color:#ae81ff>echo \&#34;##### Successfully provisioned $host...</span> <span style=color:#75715e>####\&#34;</span>
      <span style=color:#ae81ff>done</span>
</code></pre></div><h2 id=conclusion>Conclusion</h2>
<p>In this post we have learned how to get rid of local container registries at all. As you have mentioned in the gitlab manifest,
it is also possible to push standard images from the official docker hub to your kubelet nodes in the same manner. Feel free to try it out.</p>
<h3 id=update>Update</h3>
<p>Just watched the <a href="https://www.youtube.com/watch?v=aR12Oij4CYw">TALK</a> of Darren Shepherd, the Founder of <strong>k3s</strong>,
at Kubecon Europe and learned about the capability to deploy docker image tarballs to <code>${k3s}/images/app</code> (look at the skipped slide about pipelines at 26:26). Nevertheless, my method takes fewer steps to deploy an image, so may be this post has still a small take away for you ;)</p>
<p>If anything in this article is unclear or you want to add some useful informations, write a comment or just mention me on <a href=https://twitter.com/lk012>Twitter</a></p>
</div>
</section>
<section id=tag-pane class=meta>
</section>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ghost-blog-9.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
<section id=menu-pane class="menu text-center">
<h4 class=text-center><a class=menu-item href=https://brice187.github.io>home</a></h4>
</section>
<footer class="text-center footer">
<hr>
<h6 class="text-center copyright">© 2021. Lars Kerick. <a href=http://creativecommons.org/licenses/by/3.0/>Some Rights Reserved</a>.</h6>
<h6 class="text-center powered">Powered by <a href=https://gohugo.io/>Hugo v0.92.2</a> & <a href=https://github.com/shenoybr/hugo-goa>Goa</a>.</h6>
<h6><a href aria-label="RSS Feed"><i class="fas fa-rss" aria-hidden=true></i></a></h6>
</footer>
</div>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script>
<script type=text/javascript>hljs.initHighlightingOnLoad()</script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=/js/main.js></script>
<script src=/js/custom.js></script>
</body>
</html>